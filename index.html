<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>북샵 - 당신의 책을 만나보세요</title>

  <!-- Tailwind CSS: 클래스 이름만으로 스타일링할 수 있게 해주는 CSS 프레임워크 -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Tailwind 커스텀 설정: 우리만의 색상과 폰트를 정의 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          /* 쇼핑몰에서 사용할 커스텀 색상 팔레트 */
          colors: {
            primary: '#2563eb',    /* 메인 파란색 - 버튼, 강조에 사용 */
            secondary: '#f59e0b',  /* 보조 노란색 - 별점, 포인트에 사용 */
            accent: '#10b981',     /* 초록색 - 성공, 할인 표시에 사용 */
          }
        }
      }
    }
  </script>

  <!-- React: 화면을 컴포넌트 단위로 만들 수 있게 해주는 라이브러리 -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>

  <!-- Babel: JSX 문법(HTML처럼 생긴 JavaScript)을 브라우저가 이해할 수 있게 변환 -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- 토스페이먼츠 SDK v2: 결제 위젯을 렌더링하고 결제를 요청하는 도구 -->
  <script src="https://js.tosspayments.com/v2/standard"></script>

  <style>
    /* 부드러운 스크롤 효과 */
    html { scroll-behavior: smooth; }

    /* 장바구니 슬라이드 애니메이션 */
    .cart-slide-in {
      animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); } /* 오른쪽 바깥에서 */
      to { transform: translateX(0); }       /* 제자리로 슬라이드 */
    }

    /* 책 카드 호버 시 살짝 위로 올라가는 효과 */
    .book-card:hover {
      transform: translateY(-4px);
    }

    /* 모바일 바텀시트: 아래에서 위로 슬라이드 */
    @keyframes slideUp {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }
    .bottom-sheet-up {
      animation: slideUp 0.3s ease-out;
    }

    /* PC 모달: 서서히 나타나며 살짝 위로 */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(16px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .modal-fade-in {
      animation: fadeIn 0.25s ease-out;
    }

    /* 오버레이: 서서히 어두워지는 배경 */
    @keyframes overlayFadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .overlay-fade-in {
      animation: overlayFadeIn 0.2s ease-out;
    }
  </style>
</head>

<body>
  <!-- React가 이 안에 모든 화면을 그려줄 거예요 (도화지 같은 역할) -->
  <div id="root"></div>

  <!-- type="text/babel"로 설정하면 Babel이 JSX를 변환해줘요 -->
  <script type="text/babel">
    // ============================================
    // 📚 1단계: 데이터는 서버 API에서 로딩해요
    // ============================================
    // 이전에는 여기에 책 데이터를 직접 넣어뒀지만,
    // 이제 관리자가 상품을 추가/수정/삭제할 수 있도록
    // DB에서 관리하고 API를 통해 불러와요
    // (App 컴포넌트의 useEffect에서 /api/books를 호출합니다)

    // ============================================
    // 📚 2단계: 가격 포맷 함수
    // ============================================
    // 숫자를 "45,000원" 같은 형식으로 바꿔주는 함수
    function formatPrice(price) {
      return price.toLocaleString("ko-KR") + "원";
    }

    // ============================================
    // ⭐ 3단계: 별점 컴포넌트
    // ============================================
    // rating(예: 4.5)을 받아서 별 아이콘으로 표시해주는 컴포넌트
    function StarRating({ rating }) {
      return (
        <div className="flex items-center gap-1">
          {/* 별 5개를 순서대로 그려요 */}
          {[1, 2, 3, 4, 5].map((star) => (
            <svg
              key={star}
              className={`w-4 h-4 ${
                /* 현재 별 번호가 rating 이하면 노란색, 아니면 회색 */
                star <= Math.round(rating) ? "text-secondary" : "text-gray-300"
              }`}
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
            </svg>
          ))}
          {/* 숫자로도 별점을 표시 */}
          <span className="text-sm text-gray-500 ml-1">{rating}</span>
        </div>
      );
    }

    // ============================================
    // 🃏 4단계: 책 카드 컴포넌트
    // ============================================
    // 각 책 하나를 카드 형태로 보여주는 컴포넌트
    function BookCard({ book, onAddToCart }) {
      // 할인율 계산: (원래가격 - 현재가격) / 원래가격 * 100
      // DB에서는 snake_case(original_price)를 사용해요
      const discount = book.original_price > book.price
        ? Math.round((1 - book.price / book.original_price) * 100)
        : 0;

      return (
        <div className="book-card bg-white rounded-xl shadow-md overflow-hidden transition-all duration-300 hover:shadow-xl flex flex-col h-full">
          {/*
            책 표지 이미지 영역
            relative: 배지를 이미지 위에 겹쳐놓기 위해 사용
          */}
          <div className="relative bg-gray-100">
            <img
              src={book.image}
              alt={book.title}
              className="w-full h-48 sm:h-64 object-contain"
              /* w-full: 너비를 부모만큼 꽉 채움 */
              /* h-48: 모바일 192px / sm:h-64: PC 256px */
              /* object-contain: 원본 비율 유지, 잘림 없이 전체 표시 */
            />
            {/* 배지 (베스트셀러, 할인 등) - badge가 있을 때만 표시 */}
            {book.badge && (
              <span className="absolute top-2 left-2 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full">
                {/* absolute: 부모(relative) 기준으로 위치 지정 */}
                {/* top-2 left-2: 왼쪽 위 모서리에서 약간 떨어진 위치 */}
                {book.badge}
              </span>
            )}
          </div>

          {/* 책 정보 영역 */}
          <div className="p-3 sm:p-4 flex flex-col flex-grow">
            {/* p-3: 모바일 12px / sm:p-4: PC 16px */}
            {/* flex-grow: 남는 공간을 이 영역이 차지하게 함 */}

            {/* 카테고리 라벨 */}
            <span className="text-xs text-primary font-semibold uppercase tracking-wide">
              {book.category}
            </span>

            {/* 책 제목 */}
            <h3 className="mt-1 text-sm sm:text-lg font-bold text-gray-900 line-clamp-2">
              {/* text-sm: 모바일 14px / sm:text-lg: PC 18px */}
              {book.title}
            </h3>

            {/* 저자 */}
            <p className="text-sm text-gray-500 mt-1">{book.author}</p>

            {/* 별점 */}
            <div className="mt-2">
              <StarRating rating={book.rating} />
            </div>

            {/* 가격 + 장바구니 버튼 영역 (카드 하단에 고정) */}
            <div className="mt-auto pt-4">
              {/* mt-auto: 위쪽 여백을 자동으로 최대한 넓혀서 아래로 밀어냄 */}
              <div className="flex items-end justify-between">
                <div>
                  {/* 할인이 있으면 원래 가격을 취소선으로 표시 */}
                  {discount > 0 && (
                    <p className="text-xs text-gray-400 line-through">
                      {formatPrice(book.original_price)}
                    </p>
                  )}
                  <p className="text-base sm:text-xl font-bold text-gray-900">
                    {/* 할인율 표시 */}
                    {discount > 0 && (
                      <span className="text-red-500 mr-1">{discount}%</span>
                    )}
                    {formatPrice(book.price)}
                  </p>
                </div>

                {/* 장바구니 담기 버튼 */}
                <button
                  onClick={() => onAddToCart(book)}
                  className="bg-primary hover:bg-blue-700 text-white p-2 rounded-lg transition-colors duration-200 min-w-[44px] min-h-[44px] flex items-center justify-center"
                  /* min-w-[44px] min-h-[44px]: 터치 타겟 최소 44px (Apple HIG 기준) */
                  /* transition-colors: 색상이 부드럽게 변하는 효과 */
                >
                  {/* 장바구니 아이콘 (SVG) */}
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 100 4 2 2 0 000-4z" />
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // ============================================
    // 🛒 5단계: 장바구니 패널 컴포넌트
    // ============================================
    // 오른쪽에서 슬라이드로 열리는 장바구니 화면
    function CartPanel({ cart, onClose, onUpdateQuantity, onRemove, onCheckout }) {
      // 총 금액 계산: 각 상품의 (가격 × 수량)을 모두 더함
      const totalPrice = cart.reduce(
        (sum, item) => sum + item.price * item.quantity,
        0  /* 초기값 0부터 시작 */
      );

      // 총 수량 계산
      const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);

      return (
        /* 장바구니 배경 오버레이 (반투명 검정) */
        <div
          className="fixed inset-0 z-50 flex justify-end"
          /* fixed: 스크롤해도 화면에 고정 */
          /* inset-0: 상하좌우 모두 0 → 화면 전체를 덮음 */
          /* z-50: 다른 요소보다 위에 표시 (레이어 순서) */
          /* justify-end: 오른쪽 끝에 정렬 */
        >
          {/* 클릭하면 장바구니 닫히는 반투명 배경 */}
          <div
            className="absolute inset-0 bg-black bg-opacity-50"
            onClick={onClose}
          />

          {/* 장바구니 패널 본체 */}
          <div className="cart-slide-in relative w-full max-w-md bg-white shadow-2xl flex flex-col">
            {/* max-w-md: 최대 너비 448px (너무 넓어지지 않게) */}

            {/* 장바구니 헤더 */}
            <div className="flex items-center justify-between p-4 sm:p-6 border-b">
              <h2 className="text-xl font-bold text-gray-900">
                장바구니 ({totalItems})
              </h2>
              {/* 닫기(X) 버튼 */}
              <button
                onClick={onClose}
                className="text-gray-400 hover:text-gray-600 transition-colors"
              >
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>

            {/* 장바구니 상품 목록 (스크롤 가능) */}
            <div className="flex-1 overflow-y-auto p-4 sm:p-6">
              {/* flex-1: 남는 공간을 모두 차지 */}
              {/* overflow-y-auto: 내용이 넘치면 세로 스크롤 생성 */}

              {cart.length === 0 ? (
                /* 장바구니가 비어있을 때 */
                <div className="text-center py-16">
                  <svg className="w-16 h-16 mx-auto text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 100 4 2 2 0 000-4z" />
                  </svg>
                  <p className="mt-4 text-gray-500">장바구니가 비어있습니다</p>
                </div>
              ) : (
                /* 장바구니에 상품이 있을 때 */
                <div className="space-y-4">
                  {/* space-y-4: 자식 요소들 사이에 16px 간격 */}
                  {cart.map((item) => (
                    <div key={item.id} className="flex gap-4 bg-gray-50 rounded-lg p-3">
                      {/* 작은 책 표지 이미지 */}
                      <img
                        src={item.image}
                        alt={item.title}
                        className="w-16 h-20 object-cover rounded"
                      />
                      <div className="flex-1 min-w-0">
                        {/* min-w-0: 텍스트가 넘칠 때 줄임(...) 처리 가능하게 */}
                        <h4 className="font-semibold text-sm text-gray-900 truncate">
                          {item.title}
                        </h4>
                        <p className="text-xs text-gray-500">{item.author}</p>
                        <p className="text-sm font-bold text-primary mt-1">
                          {formatPrice(item.price)}
                        </p>

                        {/* 수량 조절 버튼 */}
                        <div className="flex items-center gap-2 mt-2">
                          {/* 수량 감소 버튼 */}
                          <button
                            onClick={() => onUpdateQuantity(item.id, item.quantity - 1)}
                            className="w-8 h-8 sm:w-6 sm:h-6 rounded bg-gray-200 hover:bg-gray-300 flex items-center justify-center text-sm font-bold transition-colors"
                          >
                            −
                          </button>
                          {/* 현재 수량 */}
                          <span className="text-sm font-semibold w-6 text-center">
                            {item.quantity}
                          </span>
                          {/* 수량 증가 버튼 */}
                          <button
                            onClick={() => onUpdateQuantity(item.id, item.quantity + 1)}
                            className="w-8 h-8 sm:w-6 sm:h-6 rounded bg-gray-200 hover:bg-gray-300 flex items-center justify-center text-sm font-bold transition-colors"
                          >
                            +
                          </button>
                          {/* 삭제 버튼 */}
                          <button
                            onClick={() => onRemove(item.id)}
                            className="ml-auto text-red-400 hover:text-red-600 transition-colors"
                          >
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                          </button>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>

            {/* 장바구니 하단: 총 금액 + 주문 버튼 */}
            {cart.length > 0 && (
              <div className="border-t p-4 sm:p-6 space-y-3 sm:space-y-4">
                {/* 배송비 안내 */}
                <div className="flex justify-between text-sm text-gray-500">
                  <span>배송비</span>
                  <span>{totalPrice >= 30000 ? "무료" : formatPrice(3000)}</span>
                </div>
                {/* 총 결제 금액 */}
                <div className="flex justify-between text-lg font-bold">
                  <span>총 결제금액</span>
                  <span className="text-primary">
                    {formatPrice(totalPrice >= 30000 ? totalPrice : totalPrice + 3000)}
                  </span>
                </div>
                {/* 3만원 이상 무료배송 안내 */}
                {totalPrice < 30000 && (
                  <p className="text-xs text-accent text-center">
                    {formatPrice(30000 - totalPrice)} 더 담으면 무료배송!
                  </p>
                )}
                {/* 주문하기 버튼 — 클릭하면 결제 페이지로 이동 */}
                <button
                  onClick={onCheckout}
                  className="w-full bg-primary hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition-colors duration-200"
                >
                  주문하기
                </button>
              </div>
            )}
          </div>
        </div>
      );
    }

    // ============================================
    // 💳 6단계: 결제 페이지 컴포넌트
    // ============================================
    // 토스페이먼츠 결제 위젯을 렌더링하고, "결제하기" 버튼을 누르면 결제를 진행해요
    //
    // 동작 흐름:
    // 1. 컴포넌트가 화면에 나타남 (mount)
    // 2. useEffect에서 토스페이먼츠 위젯 초기화
    // 3. 결제 수단 선택 UI + 약관 동의 UI 렌더링
    // 4. "결제하기" 버튼 클릭 → requestPayment() → 토스 결제 창 열림
    // 5. 결제 완료 후 /success 또는 /fail로 리다이렉트
    function CheckoutPage({ cart, user, onBack, showToast }) {
      // 위젯 로딩 상태와 에러 상태
      const [loading, setLoading] = React.useState(true);
      const [error, setError] = React.useState('');
      // useRef: 리렌더링 없이 값을 기억하는 도구 (위젯 인스턴스를 저장)
      const widgetsRef = React.useRef(null);

      // --- 금액 계산 ---
      // 상품 금액 합계
      const totalPrice = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
      // 배송비: 3만원 이상이면 무료, 미만이면 3,000원
      const shippingFee = totalPrice >= 30000 ? 0 : 3000;
      // 최종 결제 금액
      const finalAmount = totalPrice + shippingFee;

      // 주문명 생성 (예: "모던 자바스크립트 Deep Dive 외 2건")
      const orderName = cart.length === 1
        ? cart[0].title
        : cart[0].title + ' 외 ' + (cart.length - 1) + '건';

      // --- 토스페이먼츠 위젯 초기화 ---
      // 컴포넌트가 화면에 나타날 때 한 번만 실행돼요
      React.useEffect(() => {
        async function initWidget() {
          try {
            // 1. 토스페이먼츠 객체 생성 (클라이언트키 필요)
            const clientKey = 'test_gck_docs_Ovk5rk1EwkEbP0W43n07xlzm';
            // 로그인한 사용자의 고유 ID를 customerKey로 사용
            const customerKey = 'bookshop_user_' + user.id;
            const tossPayments = TossPayments(clientKey);

            // 2. 결제 위젯 인스턴스 생성
            const widgets = tossPayments.widgets({ customerKey });

            // 3. 결제 금액 설정 (위젯 렌더링 전에 반드시 먼저 호출해야 해요)
            await widgets.setAmount({
              currency: 'KRW',    // 통화: 한국 원
              value: finalAmount,  // 금액: 상품가 + 배송비
            });

            // 4. 결제 수단 선택 UI + 약관 동의 UI를 동시에 렌더링
            // Promise.all: 두 작업을 동시에 실행하고 둘 다 끝날 때까지 대기
            await Promise.all([
              widgets.renderPaymentMethods({
                selector: '#payment-method',  // 이 div 안에 결제 수단 UI가 그려져요
                variantKey: 'DEFAULT',
              }),
              widgets.renderAgreement({
                selector: '#agreement',       // 이 div 안에 약관 동의 UI가 그려져요
                variantKey: 'AGREEMENT',
              }),
            ]);

            // 위젯 인스턴스를 ref에 저장 (결제 요청 시 사용)
            widgetsRef.current = widgets;
            setLoading(false);
          } catch (err) {
            console.error('결제 위젯 초기화 오류:', err);
            setError('결제 위젯을 불러오는데 실패했습니다');
            setLoading(false);
          }
        }

        initWidget();
      }, []);

      // --- 결제 요청 함수 ---
      // "결제하기" 버튼을 누르면 실행돼요
      async function handlePayment() {
        if (!widgetsRef.current) return;

        try {
          // 주문 ID 생성: 타임스탬프 + 랜덤 문자열로 고유한 값을 만들어요
          // 토스페이먼츠 규격: 6자 이상 64자 이하, 영문/숫자/-/_ 만 허용
          const orderId = 'BOOKSHOP_' + Date.now() + '_' + Math.random().toString(36).substring(2, 8);

          // 토스페이먼츠 결제 요청!
          // 이 함수가 호출되면 토스 결제 창이 열리고,
          // 결제가 완료되면 successUrl로, 실패하면 failUrl로 리다이렉트돼요
          await widgetsRef.current.requestPayment({
            orderId: orderId,
            orderName: orderName,
            successUrl: window.location.origin + '/success',
            failUrl: window.location.origin + '/fail',
            customerEmail: user.email,
            customerName: user.email.split('@')[0],
          });
        } catch (err) {
          // 사용자가 결제 창을 닫은 경우
          if (err.code === 'USER_CANCEL') {
            showToast('결제가 취소되었습니다');
          } else {
            showToast('결제 중 오류가 발생했습니다');
          }
        }
      }

      return (
        <div className="min-h-screen bg-gray-50">
          {/* 상단 헤더: 뒤로가기 + 제목 */}
          <header className="bg-white shadow-sm sticky top-0 z-40">
            <div className="max-w-3xl mx-auto px-4 py-4 flex items-center gap-4">
              <button onClick={onBack} className="text-gray-600 hover:text-gray-900 transition-colors">
                {/* 왼쪽 화살표 아이콘 (뒤로가기) */}
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                </svg>
              </button>
              <h1 className="text-xl font-bold text-gray-900">주문/결제</h1>
            </div>
          </header>

          <main className="max-w-3xl mx-auto px-4 py-4 sm:py-8 space-y-6">
            {/* === 주문 상품 요약 카드 === */}
            <div className="bg-white rounded-xl shadow-sm p-4 sm:p-6">
              <h2 className="text-lg font-bold text-gray-900 mb-4">주문 상품</h2>
              <div className="space-y-3">
                {cart.map((item) => (
                  <div key={item.id} className="flex items-center gap-3">
                    <img src={item.image} alt={item.title} className="w-12 h-16 object-cover rounded" />
                    <div className="flex-1">
                      <p className="text-sm font-medium text-gray-900">{item.title}</p>
                      <p className="text-xs text-gray-500">{item.author} | {item.quantity}권</p>
                    </div>
                    <p className="text-sm font-bold text-gray-900">{formatPrice(item.price * item.quantity)}</p>
                  </div>
                ))}
              </div>
              {/* 금액 합계 */}
              <div className="border-t mt-4 pt-4 space-y-2">
                <div className="flex justify-between text-sm text-gray-500">
                  <span>상품 금액</span>
                  <span>{formatPrice(totalPrice)}</span>
                </div>
                <div className="flex justify-between text-sm text-gray-500">
                  <span>배송비</span>
                  <span>{shippingFee === 0 ? '무료' : formatPrice(shippingFee)}</span>
                </div>
                <div className="flex justify-between text-lg font-bold text-gray-900">
                  <span>총 결제금액</span>
                  <span className="text-primary">{formatPrice(finalAmount)}</span>
                </div>
              </div>
            </div>

            {/* === 결제 수단 위젯 (토스페이먼츠 SDK가 이 안에 UI를 그려줘요) === */}
            <div className="bg-white rounded-xl shadow-sm p-4 sm:p-6">
              {loading && (
                <div className="text-center py-8">
                  <div className="inline-block w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
                  <p className="text-gray-500 mt-3">결제 수단을 불러오는 중...</p>
                </div>
              )}
              {error && (
                <div className="text-center py-8">
                  <p className="text-red-500">{error}</p>
                </div>
              )}
              <div id="payment-method"></div>
            </div>

            {/* === 약관 동의 위젯 === */}
            <div className="bg-white rounded-xl shadow-sm p-4 sm:p-6">
              <div id="agreement"></div>
            </div>

            {/* === 결제하기 버튼 (모바일: 하단 고정) === */}
            <div className="sticky bottom-0 bg-gray-50 pt-2 pb-4 sm:static sm:bg-transparent sm:pt-0 sm:pb-0">
              <button
                onClick={handlePayment}
                disabled={loading || !!error}
                className="w-full bg-primary hover:bg-blue-700 text-white font-bold py-4 rounded-xl transition-colors duration-200 disabled:opacity-50 text-lg"
              >
                {formatPrice(finalAmount)} 결제하기
              </button>
            </div>
          </main>
        </div>
      );
    }

    // ============================================
    // ✅ 결제 성공 페이지 컴포넌트
    // ============================================
    // 결제가 완료된 후 보여주는 화면이에요
    // 주문번호, 결제금액, 결제수단 등의 정보를 표시합니다
    function SuccessPage({ result, onGoHome }) {
      // result가 아직 없으면 (서버 승인 처리 중) 로딩 표시
      if (!result) {
        return (
          <div className="min-h-screen bg-gray-50 flex items-center justify-center">
            <div className="text-center">
              <div className="inline-block w-10 h-10 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
              <p className="text-gray-500 mt-4">결제 승인 처리 중...</p>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl shadow-lg max-w-md w-full p-6 sm:p-8 text-center">
            {/* 성공 체크 아이콘 (초록색 원 안에 체크) */}
            <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg className="w-8 h-8 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
              </svg>
            </div>
            <h2 className="text-2xl font-bold text-gray-900 mb-2">결제가 완료되었습니다</h2>
            <p className="text-gray-500 mb-6">주문이 정상적으로 접수되었습니다</p>

            {/* 주문 상세 정보 */}
            {result.data && (
              <div className="bg-gray-50 rounded-lg p-4 mb-6 text-left space-y-2">
                <div className="flex justify-between text-sm">
                  <span className="text-gray-500">주문번호</span>
                  <span className="font-medium text-gray-900">{result.data.orderId}</span>
                </div>
                <div className="flex justify-between text-sm">
                  <span className="text-gray-500">결제금액</span>
                  <span className="font-bold text-primary">
                    {formatPrice(result.data.totalAmount)}
                  </span>
                </div>
                <div className="flex justify-between text-sm">
                  <span className="text-gray-500">결제수단</span>
                  <span className="font-medium text-gray-900">{result.data.method || '카드'}</span>
                </div>
              </div>
            )}

            <button
              onClick={() => {
                // 브라우저 URL을 홈(/)으로 깨끗하게 변경 (뒤로가기 시 /success로 안 감)
                window.history.replaceState(null, '', '/');
                onGoHome();
              }}
              className="w-full bg-primary hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition-colors"
            >
              홈으로 돌아가기
            </button>
          </div>
        </div>
      );
    }

    // ============================================
    // ❌ 결제 실패 페이지 컴포넌트
    // ============================================
    // 결제가 실패했을 때 보여주는 화면이에요
    // 에러 코드와 메시지를 표시합니다
    function FailPage({ result, onGoHome }) {
      return (
        <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl shadow-lg max-w-md w-full p-6 sm:p-8 text-center">
            {/* 실패 X 아이콘 (빨간색 원 안에 X) */}
            <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg className="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </div>
            <h2 className="text-2xl font-bold text-gray-900 mb-2">결제에 실패했습니다</h2>
            <p className="text-gray-500 mb-6">
              {result?.message || '알 수 없는 오류가 발생했습니다'}
            </p>

            {/* 에러 코드 표시 */}
            {result?.code && (
              <p className="text-xs text-gray-400 mb-6">오류 코드: {result.code}</p>
            )}

            <button
              onClick={() => {
                window.history.replaceState(null, '', '/');
                onGoHome();
              }}
              className="w-full bg-primary hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition-colors"
            >
              홈으로 돌아가기
            </button>
          </div>
        </div>
      );
    }

    // ============================================
    // 📖 7단계: 책 상세 모달 컴포넌트
    // ============================================
    function BookDetail({ book, onClose, onAddToCart }) {
      if (!book) return null;

      const discount = book.original_price > book.price
        ? Math.round((1 - book.price / book.original_price) * 100)
        : 0;

      return (
        <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center p-0 sm:p-4">
          {/* 배경 오버레이 */}
          <div className="overlay-fade-in absolute inset-0 bg-black bg-opacity-50" onClick={onClose} />

          {/* 모달 본체 — 모바일: 바텀시트 / PC: 센터 모달 */}
          <div className="bottom-sheet-up sm:modal-fade-in relative bg-white rounded-t-2xl sm:rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            {/* 바텀시트 드래그 핸들 (모바일에서만 표시) */}
            <div className="sm:hidden flex justify-center pt-3 pb-1">
              <div className="w-10 h-1 bg-gray-300 rounded-full"></div>
            </div>
            {/* 닫기 버튼 */}
            <button
              onClick={onClose}
              className="absolute top-4 right-4 z-10 bg-white rounded-full p-2 sm:p-1 shadow-md text-gray-400 hover:text-gray-600"
            >
              <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>

            <div className="md:flex">
              {/* 책 표지 */}
              <div className="md:w-1/2 bg-gray-100">
                <img
                  src={book.image}
                  alt={book.title}
                  className="w-full h-48 sm:h-72 md:h-full object-contain p-4 sm:rounded-t-2xl md:rounded-l-2xl md:rounded-tr-none"
                />
              </div>
              {/* 책 정보 */}
              <div className="p-4 sm:p-6 md:w-1/2 flex flex-col">
                <span className="text-sm text-primary font-semibold">{book.category}</span>
                <h2 className="text-xl sm:text-2xl font-bold text-gray-900 mt-1">{book.title}</h2>
                <p className="text-gray-500 mt-1">{book.author}</p>
                <div className="mt-3">
                  <StarRating rating={book.rating} />
                </div>
                <p className="text-gray-600 mt-4 leading-relaxed">{book.description}</p>

                <div className="mt-auto pt-6">
                  <div className="mb-4">
                    {discount > 0 && (
                      <p className="text-sm text-gray-400 line-through">
                        {formatPrice(book.original_price)}
                      </p>
                    )}
                    <p className="text-xl sm:text-2xl font-bold">
                      {discount > 0 && (
                        <span className="text-red-500 mr-1">{discount}%</span>
                      )}
                      {formatPrice(book.price)}
                    </p>
                  </div>
                  <button
                    onClick={() => { onAddToCart(book); onClose(); }}
                    className="w-full bg-primary hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition-colors duration-200"
                  >
                    장바구니에 담기
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // ============================================
    // 🔑 7단계: 로그인 모달 컴포넌트
    // ============================================
    // 이메일과 비밀번호를 입력받아 서버에 로그인 요청을 보내는 화면
    function LoginModal({ onClose, onSwitchToRegister, onLoginSuccess }) {
      // 입력값과 상태를 관리하는 state들
      const [email, setEmail] = React.useState('');
      const [password, setPassword] = React.useState('');
      const [error, setError] = React.useState('');       // 에러 메시지
      const [loading, setLoading] = React.useState(false); // 로딩 중 여부
      const [showPassword, setShowPassword] = React.useState(false); // 비밀번호 보기 여부

      // 폼 제출 시 실행되는 함수
      async function handleSubmit(e) {
        e.preventDefault(); // 페이지 새로고침 방지 (폼의 기본 동작)
        setError('');
        setLoading(true);

        try {
          // 서버의 로그인 API에 요청 보내기
          const res = await fetch('/api/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
            // JSON.stringify: 자바스크립트 객체를 JSON 문자열로 변환
          });

          const data = await res.json(); // 서버 응답을 JSON으로 변환

          if (res.ok) {
            // 로그인 성공!
            // 토큰을 localStorage에 저장 (브라우저를 닫아도 유지됨)
            localStorage.setItem('token', data.token);
            onLoginSuccess(data.user); // 부모 컴포넌트에 사용자 정보 전달
            onClose(); // 모달 닫기
          } else {
            // 로그인 실패 (이메일/비밀번호 틀림 등)
            setError(data.error);
          }
        } catch (err) {
          setError('서버 연결에 실패했습니다');
        }
        setLoading(false);
      }

      return (
        <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center p-0 sm:p-4">
          {/* 반투명 배경 오버레이 */}
          <div className="overlay-fade-in absolute inset-0 bg-black bg-opacity-50" onClick={onClose} />

          {/* 모달 본체 — 모바일: 바텀시트 / PC: 센터 모달 */}
          <div className="bottom-sheet-up sm:modal-fade-in relative bg-white rounded-t-2xl sm:rounded-2xl shadow-2xl max-w-md w-full p-5 sm:p-8">
            {/* 바텀시트 드래그 핸들 (모바일에서만 표시) */}
            <div className="sm:hidden flex justify-center pb-2">
              <div className="w-10 h-1 bg-gray-300 rounded-full"></div>
            </div>
            {/* 닫기 버튼 */}
            <button onClick={onClose} className="absolute top-4 right-4 p-2 sm:p-0 text-gray-400 hover:text-gray-600">
              <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>

            {/* 제목 */}
            <h2 className="text-xl sm:text-2xl font-bold text-gray-900 mb-6">로그인</h2>

            {/* 에러 메시지 (있을 때만 표시) */}
            {error && (
              <p className="text-red-500 text-sm mb-4 bg-red-50 p-3 rounded-lg">{error}</p>
            )}

            {/* 로그인 폼 */}
            <form onSubmit={handleSubmit} className="space-y-4">
              {/* space-y-4: 폼 안의 각 입력 필드 사이 간격 16px */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">이메일</label>
                <input
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  required
                  placeholder="example@email.com"
                  className="w-full px-4 py-3 sm:py-2 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">비밀번호</label>
                {/* 비밀번호 입력 + 보기/숨기기 버튼을 감싸는 컨테이너 */}
                <div className="relative">
                  <input
                    type={showPassword ? "text" : "password"}
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    required
                    placeholder="비밀번호 입력"
                    className="w-full px-4 py-3 sm:py-2 pr-10 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none"
                  />
                  {/* 눈 아이콘: 클릭하면 비밀번호 보기/숨기기 토글 */}
                  <button
                    type="button"
                    onClick={() => setShowPassword(!showPassword)}
                    className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
                  >
                    {showPassword ? (
                      /* 눈 감은 아이콘 (비밀번호 보이는 상태 → 클릭하면 숨김) */
                      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21" />
                      </svg>
                    ) : (
                      /* 눈 뜬 아이콘 (비밀번호 숨긴 상태 → 클릭하면 보임) */
                      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                      </svg>
                    )}
                  </button>
                </div>
              </div>
              <button
                type="submit"
                disabled={loading}
                className="w-full bg-primary hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition-colors disabled:opacity-50"
                /* disabled:opacity-50: 로딩 중일 때 버튼을 반투명하게 */
              >
                {loading ? '로그인 중...' : '로그인'}
              </button>
            </form>

            {/* 회원가입으로 전환 링크 */}
            <p className="text-center text-sm text-gray-500 mt-4">
              계정이 없으신가요?{' '}
              <button onClick={onSwitchToRegister} className="text-primary font-semibold hover:underline">
                회원가입
              </button>
            </p>
          </div>
        </div>
      );
    }

    // ============================================
    // 📝 8단계: 회원가입 모달 컴포넌트
    // ============================================
    // 이름, 이메일, 비밀번호를 입력받아 서버에 가입 요청을 보내는 화면
    function RegisterModal({ onClose, onSwitchToLogin }) {
      const [email, setEmail] = React.useState('');
      const [password, setPassword] = React.useState('');
      const [error, setError] = React.useState('');
      const [loading, setLoading] = React.useState(false);
      const [showPassword, setShowPassword] = React.useState(false); // 비밀번호 보기 여부

      // 비밀번호 규칙 실시간 검증 (입력할 때마다 체크)
      // 서버의 validatePasswordStrength 규칙과 동일하게 맞춤
      const passwordRules = [
        { label: '8자 이상', met: password.length >= 8 },
        { label: '대문자 포함 (A-Z)', met: /[A-Z]/.test(password) },
        { label: '숫자 포함 (0-9)', met: /\d/.test(password) },
        { label: '특수문자 포함 (!@#$%^&* 등)', met: /[!@#$%^&*(),.?":{}|<>]/.test(password) },
      ];
      const allRulesMet = passwordRules.every(r => r.met);

      async function handleSubmit(e) {
        e.preventDefault();
        setError('');

        // 비밀번호 규칙 검증 (서버와 동일한 규칙으로 미리 확인)
        if (!allRulesMet) {
          setError('비밀번호가 아래 규칙을 모두 만족해야 합니다');
          return;
        }

        setLoading(true);

        try {
          const res = await fetch('/api/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
          });

          const data = await res.json();

          if (res.ok) {
            // 회원가입 성공 → 로그인 모달로 전환
            onSwitchToLogin();
          } else {
            setError(data.error);
          }
        } catch (err) {
          setError('서버 연결에 실패했습니다');
        }
        setLoading(false);
      }

      return (
        <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center p-0 sm:p-4">
          <div className="overlay-fade-in absolute inset-0 bg-black bg-opacity-50" onClick={onClose} />

          <div className="bottom-sheet-up sm:modal-fade-in relative bg-white rounded-t-2xl sm:rounded-2xl shadow-2xl max-w-md w-full p-5 sm:p-8 max-h-[90vh] overflow-y-auto">
            {/* 바텀시트 드래그 핸들 (모바일에서만 표시) */}
            <div className="sm:hidden flex justify-center pb-2">
              <div className="w-10 h-1 bg-gray-300 rounded-full"></div>
            </div>
            <button onClick={onClose} className="absolute top-4 right-4 p-2 sm:p-0 text-gray-400 hover:text-gray-600">
              <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>

            <h2 className="text-xl sm:text-2xl font-bold text-gray-900 mb-6">회원가입</h2>

            {error && (
              <p className="text-red-500 text-sm mb-4 bg-red-50 p-3 rounded-lg">{error}</p>
            )}

            <form onSubmit={handleSubmit} className="space-y-4">
              {/* 이메일 입력 */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">이메일</label>
                <input
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  required
                  placeholder="example@email.com"
                  className="w-full px-4 py-3 sm:py-2 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none"
                />
              </div>
              {/* 비밀번호 입력 */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">비밀번호</label>
                {/* 비밀번호 입력 + 보기/숨기기 버튼을 감싸는 컨테이너 */}
                <div className="relative">
                  <input
                    type={showPassword ? "text" : "password"}
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    required
                    placeholder="8자 이상, 대문자/숫자/특수문자 포함"
                    className="w-full px-4 py-3 sm:py-2 pr-10 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none"
                  />
                  {/* 눈 아이콘: 클릭하면 비밀번호 보기/숨기기 토글 */}
                  <button
                    type="button"
                    onClick={() => setShowPassword(!showPassword)}
                    className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
                  >
                    {showPassword ? (
                      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21" />
                      </svg>
                    ) : (
                      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                      </svg>
                    )}
                  </button>
                </div>

                {/* 비밀번호 규칙 안내 (실시간으로 충족 여부 표시) */}
                {/* 비밀번호를 입력하기 시작하면 규칙 목록이 나타나요 */}
                <ul className="mt-2 space-y-0.5 sm:space-y-1">
                  {passwordRules.map((rule, i) => (
                    <li key={i} className={`text-xs flex items-center gap-1.5 ${
                      password.length === 0
                        ? 'text-gray-400'           /* 입력 전: 회색 */
                        : rule.met
                          ? 'text-green-500'         /* 충족: 초록색 */
                          : 'text-red-400'           /* 미충족: 빨간색 */
                    }`}>
                      {/* 체크/X 아이콘 */}
                      {password.length > 0 && rule.met ? (
                        <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                        </svg>
                      ) : (
                        <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <circle cx="12" cy="12" r="9" strokeWidth={2} />
                        </svg>
                      )}
                      {rule.label}
                    </li>
                  ))}
                </ul>
              </div>
              <button
                type="submit"
                disabled={loading}
                className="w-full bg-primary hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition-colors disabled:opacity-50"
              >
                {loading ? '가입 중...' : '회원가입'}
              </button>
            </form>

            {/* 로그인으로 전환 링크 */}
            <p className="text-center text-sm text-gray-500 mt-4">
              이미 계정이 있으신가요?{' '}
              <button onClick={onSwitchToLogin} className="text-primary font-semibold hover:underline">
                로그인
              </button>
            </p>
          </div>
        </div>
      );
    }

    // ============================================
    // 🔧 관리자 페이지: 상품 관리 + 주문 관리
    // ============================================
    // 관리자만 접근할 수 있는 페이지예요
    // 상품 등록/수정/삭제, 주문 조회/상태 변경을 할 수 있어요

    // --- 히어로 배너 (최근 등록 책 롤링) ---
    function HeroSection({ books, onSelectBook }) {
      const recentBooks = React.useMemo(
        () => [...books].sort((a, b) => b.id - a.id).slice(0, 5),
        [books]
      );
      const [heroIndex, setHeroIndex] = React.useState(0);

      React.useEffect(() => {
        if (recentBooks.length === 0) return;
        const timer = setInterval(() => {
          setHeroIndex(prev => (prev + 1) % recentBooks.length);
        }, 3500);
        return () => clearInterval(timer);
      }, [recentBooks.length]);

      const currentBook = recentBooks[heroIndex];

      return (
        <section className="bg-gradient-to-r from-blue-600 to-indigo-700 text-white">
          <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 sm:py-14">
            {recentBooks.length > 0 && currentBook ? (
              <>
              <p className="text-blue-200 text-sm font-medium mb-4 text-center sm:hidden">최근 등록된 책</p>
              <div className="flex flex-col sm:flex-row items-center gap-6 sm:gap-8">
                {/* 이미지: 모바일에서는 위쪽에 표시, PC에서는 오른쪽 */}
                <div className="flex-shrink-0 order-first sm:order-last">
                  <img
                    src={currentBook.image}
                    alt={currentBook.title}
                    className="w-32 h-44 sm:w-44 sm:h-64 object-contain rounded-xl shadow-2xl transition-all duration-500 bg-white"
                    style={{ boxShadow: '0 20px 40px rgba(0,0,0,0.3)' }}
                  />
                </div>
                {/* 텍스트: 모바일에서는 아래쪽, PC에서는 왼쪽 */}
                <div className="flex-1 text-center sm:text-left">
                  <p className="text-blue-200 text-sm font-medium mb-2 hidden sm:block">최근 등록된 책</p>
                  <h2 className="text-2xl sm:text-3xl font-extrabold leading-tight transition-all duration-500">
                    {currentBook.title}
                  </h2>
                  <p className="mt-2 text-blue-100 text-sm">{currentBook.author}</p>
                  <p className="mt-3 text-blue-100 text-sm line-clamp-2 max-w-lg mx-auto sm:mx-0">
                    {currentBook.description || ''}
                  </p>
                  <div className="mt-4 flex items-center gap-3 justify-center sm:justify-start">
                    <span className="text-2xl font-bold">{formatPrice(currentBook.price)}</span>
                    {currentBook.original_price > currentBook.price && (
                      <span className="text-blue-200 line-through text-sm">{formatPrice(currentBook.original_price)}</span>
                    )}
                  </div>
                  <button
                    onClick={() => onSelectBook(currentBook)}
                    className="mt-4 bg-white text-primary font-bold px-6 py-2 rounded-full hover:bg-blue-50 transition-colors text-sm"
                  >
                    자세히 보기
                  </button>
                  <div className="mt-5 flex gap-2 justify-center sm:justify-start">
                    {recentBooks.map((_, i) => (
                      <button
                        key={i}
                        onClick={() => setHeroIndex(i)}
                        className={`w-2 h-2 rounded-full transition-all duration-300 ${
                          i === heroIndex ? 'bg-white w-6' : 'bg-white bg-opacity-40'
                        }`}
                      />
                    ))}
                  </div>
                </div>
              </div>
              </>
            ) : (
              <div className="text-center">
                <h2 className="text-3xl sm:text-4xl font-extrabold">
                  당신의 다음 책을 만나보세요
                </h2>
                <p className="mt-4 text-lg text-blue-100 max-w-2xl mx-auto">
                  베스트셀러부터 숨겨진 명작까지, 다양한 책을 만나볼 수 있는 곳
                </p>
              </div>
            )}
            <div className="mt-6 flex justify-center gap-4">
              <span className="bg-white bg-opacity-20 px-4 py-2 rounded-full text-sm">
                3만원 이상 무료배송
              </span>
              <span className="bg-white bg-opacity-20 px-4 py-2 rounded-full text-sm">
                최대 10% 할인
              </span>
            </div>
          </div>
        </section>
      );
    }

    // --- 상품 등록/수정 폼 모달 ---
    function BookFormModal({ book, onClose, onSave }) {
      // book이 있으면 수정 모드, 없으면 등록 모드
      const isEdit = !!book;
      const [form, setForm] = React.useState({
        title: book?.title || '',
        author: book?.author || '',
        price: book?.price || '',
        original_price: book?.original_price || '',
        image: book?.image || '',
        category: book?.category || '',
        rating: book?.rating || '',
        description: book?.description || '',
        badge: book?.badge || '',
      });
      const [loading, setLoading] = React.useState(false);
      const [error, setError] = React.useState('');

      // === Google Books 검색 관련 state ===
      const [searchQuery, setSearchQuery] = React.useState('');   // 검색어
      const [searchResults, setSearchResults] = React.useState([]); // 검색 결과
      const [searching, setSearching] = React.useState(false);     // 검색 중 여부
      const [searched, setSearched] = React.useState(false);       // 검색 실행 여부

      // 입력값 변경 핸들러
      function handleChange(e) {
        setForm({ ...form, [e.target.name]: e.target.value });
      }

      // Google Books 검색 함수
      async function handleSearch() {
        if (!searchQuery.trim()) return;
        setSearching(true);
        setSearched(true);
        try {
          const token = localStorage.getItem('token');
          const res = await fetch('/api/admin/books/search?q=' + encodeURIComponent(searchQuery), {
            headers: { 'Authorization': 'Bearer ' + token },
          });
          const data = await res.json();
          if (res.ok) {
            setSearchResults(data.books || []);
          } else {
            setSearchResults([]);
          }
        } catch (err) {
          setSearchResults([]);
        }
        setSearching(false);
      }

      // 검색 결과 클릭 → 폼 자동 채우기
      function handleSelectBook(result) {
        setForm({
          ...form,
          title: result.title,
          author: result.author,
          description: result.description,
          image: result.image,
          category: result.category,
          rating: result.rating || '',
          // price, original_price, badge는 수동 입력
        });
        setSearchResults([]); // 검색 결과 닫기
        setSearched(false);
      }

      // 저장 버튼 핸들러
      async function handleSubmit(e) {
        e.preventDefault();
        setLoading(true);
        setError('');
        try {
          const token = localStorage.getItem('token');
          const url = isEdit ? '/api/admin/books/' + book.id : '/api/admin/books';
          const method = isEdit ? 'PUT' : 'POST';

          const res = await fetch(url, {
            method,
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token,
            },
            body: JSON.stringify({
              ...form,
              price: parseInt(form.price),
              original_price: parseInt(form.original_price),
              rating: parseFloat(form.rating) || 0,
            }),
          });

          const data = await res.json();
          if (res.ok) {
            onSave(); // 부모에게 저장 완료 알림 (목록 새로고침)
          } else {
            setError(data.error || '저장에 실패했습니다');
          }
        } catch (err) {
          setError('서버 연결에 실패했습니다');
        }
        setLoading(false);
      }

      return (
        <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center p-0 sm:p-4">
          <div className="overlay-fade-in absolute inset-0 bg-black bg-opacity-50" onClick={onClose} />
          <div className="bottom-sheet-up sm:modal-fade-in relative bg-white rounded-t-2xl sm:rounded-2xl shadow-2xl max-w-lg w-full p-4 sm:p-6 max-h-[90vh] overflow-y-auto">
            {/* 바텀시트 드래그 핸들 (모바일에서만 표시) */}
            <div className="sm:hidden flex justify-center pb-2">
              <div className="w-10 h-1 bg-gray-300 rounded-full"></div>
            </div>
            <button onClick={onClose} className="absolute top-4 right-4 p-2 sm:p-0 text-gray-400 hover:text-gray-600">
              <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>

            <h2 className="text-xl font-bold text-gray-900 mb-4">
              {isEdit ? '상품 수정' : '새 상품 등록'}
            </h2>

            {/* === Google Books 검색 섹션 (등록 모드에서만 표시) === */}
            {!isEdit && (
              <div className="mb-4 p-3 bg-blue-50 rounded-lg">
                <label className="block text-sm font-medium text-primary mb-2">
                  Google Books에서 검색하여 자동 입력
                </label>
                <div className="flex gap-2">
                  <input
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    onKeyDown={(e) => { if (e.key === 'Enter') { e.preventDefault(); handleSearch(); } }}
                    placeholder="책 제목 또는 저자 검색..."
                    className="flex-1 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:outline-none text-sm"
                  />
                  <button
                    type="button"
                    onClick={handleSearch}
                    disabled={searching}
                    className="bg-primary hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors disabled:opacity-50 whitespace-nowrap"
                  >
                    {searching ? '검색중...' : '검색'}
                  </button>
                </div>

                {/* 검색 결과 리스트 */}
                {searched && searchResults.length > 0 && (
                  <div className="mt-2 border rounded-lg bg-white max-h-48 overflow-y-auto">
                    {searchResults.map((result, i) => (
                      <button
                        key={i}
                        type="button"
                        onClick={() => handleSelectBook(result)}
                        className="w-full flex items-center gap-3 p-2 hover:bg-gray-50 border-b last:border-b-0 text-left transition-colors"
                      >
                        {result.image && (
                          <img src={result.image} alt="" className="w-10 h-14 object-cover rounded flex-shrink-0" />
                        )}
                        <div className="min-w-0">
                          <p className="text-sm font-medium text-gray-900 truncate">{result.title}</p>
                          <p className="text-xs text-gray-500 truncate">{result.author}</p>
                          <p className="text-xs text-gray-400">{result.category}</p>
                        </div>
                      </button>
                    ))}
                  </div>
                )}
                {searched && !searching && searchResults.length === 0 && (
                  <p className="mt-2 text-xs text-gray-500">검색 결과가 없습니다</p>
                )}
              </div>
            )}

            {error && <p className="text-red-500 text-sm mb-3 bg-red-50 p-2 rounded">{error}</p>}

            <form onSubmit={handleSubmit} className="space-y-3">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">제목 *</label>
                <input name="title" value={form.title} onChange={handleChange} required
                  className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:outline-none" />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">저자 *</label>
                <input name="author" value={form.author} onChange={handleChange} required
                  className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:outline-none" />
              </div>
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">판매가 *</label>
                  <input name="price" type="number" value={form.price} onChange={handleChange} required
                    placeholder="가격 입력"
                    className={`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:outline-none ${
                      form.title && !form.price ? 'border-red-300 bg-red-50' : ''
                    }`} />
                  {form.title && !form.price && (
                    <p className="text-xs text-red-400 mt-1">가격을 입력해주세요</p>
                  )}
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">정가 *</label>
                  <input name="original_price" type="number" value={form.original_price} onChange={handleChange} required
                    placeholder="정가 입력"
                    className={`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:outline-none ${
                      form.title && !form.original_price ? 'border-red-300 bg-red-50' : ''
                    }`} />
                  {form.title && !form.original_price && (
                    <p className="text-xs text-red-400 mt-1">정가를 입력해주세요</p>
                  )}
                </div>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">카테고리 *</label>
                <input name="category" value={form.category} onChange={handleChange} required placeholder="예: 프로그래밍, 소설"
                  className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:outline-none" />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">이미지 URL</label>
                <div className="flex gap-2 items-start">
                  <input name="image" value={form.image} onChange={handleChange} placeholder="https://..."
                    className="flex-1 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:outline-none" />
                  {/* 이미지 미리보기 */}
                  {form.image && (
                    <img src={form.image} alt="미리보기" className="w-10 h-14 object-cover rounded border" />
                  )}
                </div>
              </div>
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">평점</label>
                  <input name="rating" type="number" step="0.1" min="0" max="5" value={form.rating} onChange={handleChange}
                    className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:outline-none" />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">배지</label>
                  <input name="badge" value={form.badge} onChange={handleChange} placeholder="예: 베스트셀러"
                    className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:outline-none" />
                </div>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">설명</label>
                <textarea name="description" value={form.description} onChange={handleChange} rows={3}
                  className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:outline-none" />
              </div>
              <button type="submit" disabled={loading}
                className="w-full bg-primary hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition-colors disabled:opacity-50">
                {loading ? '저장 중...' : (isEdit ? '수정하기' : '등록하기')}
              </button>
            </form>
          </div>
        </div>
      );
    }

    // --- 관리자: 상품 관리 탭 ---
    function AdminBooks({ showToast }) {
      const [books, setBooks] = React.useState([]);
      const [loading, setLoading] = React.useState(true);
      const [showForm, setShowForm] = React.useState(false); // 등록/수정 폼 표시 여부
      const [editBook, setEditBook] = React.useState(null);  // 수정할 상품 (null이면 등록)
      const [seeding, setSeeding] = React.useState(false);   // Google Books 시딩 진행 중

      // 상품 목록 불러오기 (비활성 포함)
      async function loadBooks() {
        try {
          const token = localStorage.getItem('token');
          const res = await fetch('/api/admin/books', {
            headers: { 'Authorization': 'Bearer ' + token },
          });
          const data = await res.json();
          if (res.ok) setBooks(data.books);
        } catch (err) {
          console.error('상품 목록 로딩 실패:', err);
        }
        setLoading(false);
      }

      React.useEffect(() => { loadBooks(); }, []);

      // Google Books에서 약 50권 자동 시딩
      async function handleSeedGoogleBooks() {
        if (!confirm(
          '⚠️ 기존 모든 상품이 삭제되고 Google Books에서 약 50권이 새로 등록됩니다.\n\n계속하시겠습니까?'
        )) return;

        setSeeding(true);
        try {
          const token = localStorage.getItem('token');
          const res = await fetch('/api/admin/books/seed-google', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + token },
          });
          const data = await res.json();
          if (res.ok) {
            showToast(data.message);
            loadBooks();
          } else {
            showToast('시딩 실패: ' + data.error);
          }
        } catch (err) {
          showToast('서버 연결에 실패했습니다');
        }
        setSeeding(false);
      }

      // 상품 비활성화 (삭제)
      async function handleDelete(book) {
        if (!confirm(`"${book.title}" 상품을 비활성화하시겠습니까?`)) return;
        try {
          const token = localStorage.getItem('token');
          const res = await fetch('/api/admin/books/' + book.id, {
            method: 'DELETE',
            headers: { 'Authorization': 'Bearer ' + token },
          });
          if (res.ok) {
            showToast('상품이 비활성화되었습니다');
            loadBooks();
          }
        } catch (err) {
          showToast('삭제에 실패했습니다');
        }
      }

      // 상품 활성화 복원
      async function handleRestore(book) {
        try {
          const token = localStorage.getItem('token');
          const res = await fetch('/api/admin/books/' + book.id, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token,
            },
            body: JSON.stringify({ is_active: true }),
          });
          if (res.ok) {
            showToast('상품이 활성화되었습니다');
            loadBooks();
          }
        } catch (err) {
          showToast('활성화에 실패했습니다');
        }
      }

      if (loading) {
        return (
          <div className="text-center py-12">
            <div className="inline-block w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
          </div>
        );
      }

      return (
        <div>
          {/* 상단: 제목 + 시딩/등록 버튼 */}
          <div className="flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between mb-4">
            <h3 className="text-lg font-bold text-gray-900">
              전체 상품 ({books.length}개)
            </h3>
            <div className="flex gap-2 w-full sm:w-auto">
              <button
                onClick={handleSeedGoogleBooks}
                disabled={seeding}
                className={`flex-1 sm:flex-none ${seeding ? 'bg-gray-400 cursor-not-allowed' : 'bg-orange-500 hover:bg-orange-600'} text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors`}
              >
                {seeding ? '시딩 중...' : 'Google Books 시딩'}
              </button>
              <button
                onClick={() => { setEditBook(null); setShowForm(true); }}
                className="flex-1 sm:flex-none bg-primary hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors"
              >
                새 상품 등록
              </button>
            </div>
          </div>

          {/* 모바일 상품 카드 리스트 (sm 미만에서만 표시) */}
          <div className="sm:hidden space-y-3">
            {books.map((book) => (
              <div key={book.id} className={`bg-white rounded-xl shadow-sm p-4 ${!book.is_active ? 'opacity-60' : ''}`}>
                <div className="flex items-start justify-between gap-2">
                  <h4 className="font-medium text-gray-900 text-sm line-clamp-1 flex-1">{book.title}</h4>
                  <span className={`flex-shrink-0 px-2 py-0.5 rounded-full text-xs font-medium ${
                    book.is_active ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'
                  }`}>
                    {book.is_active ? '활성' : '비활성'}
                  </span>
                </div>
                <p className="text-xs text-gray-500 mt-1">{book.author} · {book.category}</p>
                <p className="text-sm font-bold text-gray-900 mt-2">{formatPrice(book.price)}</p>
                <div className="flex gap-2 mt-3">
                  <button
                    onClick={() => { setEditBook(book); setShowForm(true); }}
                    className="flex-1 bg-blue-50 text-primary hover:bg-blue-100 py-2 rounded-lg text-xs font-medium transition-colors"
                  >
                    수정
                  </button>
                  {book.is_active ? (
                    <button
                      onClick={() => handleDelete(book)}
                      className="flex-1 bg-red-50 text-red-500 hover:bg-red-100 py-2 rounded-lg text-xs font-medium transition-colors"
                    >
                      비활성화
                    </button>
                  ) : (
                    <button
                      onClick={() => handleRestore(book)}
                      className="flex-1 bg-green-50 text-accent hover:bg-green-100 py-2 rounded-lg text-xs font-medium transition-colors"
                    >
                      활성화
                    </button>
                  )}
                </div>
              </div>
            ))}
          </div>

          {/* 상품 테이블 (sm 이상에서만 표시) — 3열 구조 */}
          <div className="hidden sm:block bg-white rounded-xl shadow-sm overflow-hidden">
            <div className="overflow-x-auto">
              <table className="w-full text-sm">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-5 py-3 text-left font-medium text-gray-500">상품 정보</th>
                    <th className="px-5 py-3 text-right font-medium text-gray-500">판매가 / 상태</th>
                    <th className="px-5 py-3 text-center font-medium text-gray-500">관리</th>
                  </tr>
                </thead>
                <tbody className="divide-y">
                  {books.map((book) => (
                    <tr key={book.id} className={!book.is_active ? 'bg-gray-50 opacity-60' : ''}>
                      <td className="px-5 py-4">
                        <p className="font-medium text-gray-900">{book.title}</p>
                        <p className="text-xs text-gray-500 mt-0.5">{book.author} · {book.category}</p>
                      </td>
                      <td className="px-5 py-4 text-right">
                        <p className="font-bold text-gray-900">{formatPrice(book.price)}</p>
                        <span className={`inline-block mt-1 px-2 py-0.5 rounded-full text-xs font-medium ${
                          book.is_active
                            ? 'bg-green-100 text-green-700'
                            : 'bg-gray-100 text-gray-500'
                        }`}>
                          {book.is_active ? '활성' : '비활성'}
                        </span>
                      </td>
                      <td className="px-5 py-4 text-center">
                        <div className="flex items-center justify-center gap-2">
                          <button
                            onClick={() => { setEditBook(book); setShowForm(true); }}
                            className="bg-blue-50 text-primary hover:bg-blue-100 px-3 py-1.5 rounded-lg text-xs font-medium transition-colors"
                          >
                            수정
                          </button>
                          {book.is_active ? (
                            <button
                              onClick={() => handleDelete(book)}
                              className="bg-red-50 text-red-500 hover:bg-red-100 px-3 py-1.5 rounded-lg text-xs font-medium transition-colors"
                            >
                              비활성화
                            </button>
                          ) : (
                            <button
                              onClick={() => handleRestore(book)}
                              className="bg-green-50 text-accent hover:bg-green-100 px-3 py-1.5 rounded-lg text-xs font-medium transition-colors"
                            >
                              활성화
                            </button>
                          )}
                        </div>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>

          {/* 상품 등록/수정 모달 */}
          {showForm && (
            <BookFormModal
              book={editBook}
              onClose={() => setShowForm(false)}
              onSave={() => {
                setShowForm(false);
                loadBooks();
                showToast(editBook ? '상품이 수정되었습니다' : '새 상품이 등록되었습니다');
              }}
            />
          )}
        </div>
      );
    }

    // --- 관리자: 주문 관리 탭 ---
    function AdminOrders({ showToast }) {
      const [orders, setOrders] = React.useState([]);
      const [loading, setLoading] = React.useState(true);
      const [pagination, setPagination] = React.useState({ page: 1, totalPages: 1 });
      const [statusFilter, setStatusFilter] = React.useState('');

      // 주문 목록 불러오기
      async function loadOrders(page = 1) {
        setLoading(true);
        try {
          const token = localStorage.getItem('token');
          let url = '/api/admin/orders?page=' + page + '&limit=20';
          if (statusFilter) url += '&status=' + statusFilter;

          const res = await fetch(url, {
            headers: { 'Authorization': 'Bearer ' + token },
          });
          const data = await res.json();
          if (res.ok) {
            setOrders(data.orders);
            setPagination(data.pagination);
          }
        } catch (err) {
          console.error('주문 목록 로딩 실패:', err);
        }
        setLoading(false);
      }

      React.useEffect(() => { loadOrders(); }, [statusFilter]);

      // 주문 상태 변경
      async function handleStatusChange(orderId, newStatus) {
        try {
          const token = localStorage.getItem('token');
          const res = await fetch('/api/admin/orders/' + orderId + '/status', {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token,
            },
            body: JSON.stringify({ status: newStatus }),
          });
          if (res.ok) {
            showToast('주문 상태가 변경되었습니다');
            loadOrders(pagination.page);
          }
        } catch (err) {
          showToast('상태 변경에 실패했습니다');
        }
      }

      // 상태별 색상
      const statusColors = {
        READY: 'bg-yellow-100 text-yellow-700',
        DONE: 'bg-blue-100 text-blue-700',
        SHIPPING: 'bg-purple-100 text-purple-700',
        DELIVERED: 'bg-green-100 text-green-700',
        CANCELED: 'bg-red-100 text-red-700',
      };

      // 상태 한글 이름
      const statusNames = {
        READY: '준비중', DONE: '결제완료', SHIPPING: '배송중',
        DELIVERED: '배송완료', CANCELED: '취소됨',
      };

      return (
        <div>
          {/* 상태 필터 */}
          <div className="flex flex-wrap items-center gap-2 mb-4">
            <span className="text-sm text-gray-600">상태 필터:</span>
            <select
              value={statusFilter}
              onChange={(e) => setStatusFilter(e.target.value)}
              className="px-3 py-1.5 border rounded-lg text-sm focus:ring-2 focus:ring-primary focus:outline-none"
            >
              <option value="">전체</option>
              <option value="READY">준비중</option>
              <option value="DONE">결제완료</option>
              <option value="SHIPPING">배송중</option>
              <option value="DELIVERED">배송완료</option>
              <option value="CANCELED">취소됨</option>
            </select>
            {pagination.totalCount !== undefined && (
              <span className="text-sm text-gray-500 ml-2">
                총 {pagination.totalCount}건
              </span>
            )}
          </div>

          {loading ? (
            <div className="text-center py-12">
              <div className="inline-block w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
            </div>
          ) : orders.length === 0 ? (
            <div className="text-center py-12 text-gray-500">주문이 없습니다</div>
          ) : (
            <>
              {/* 모바일 주문 카드 리스트 (sm 미만에서만 표시) */}
              <div className="sm:hidden space-y-3">
                {orders.map((order) => (
                  <div key={order.id} className="bg-white rounded-xl shadow-sm p-4">
                    <div className="flex items-start justify-between gap-2">
                      <h4 className="font-medium text-gray-900 text-sm line-clamp-1 flex-1">{order.order_name}</h4>
                      <span className={`flex-shrink-0 px-2 py-0.5 rounded-full text-xs font-medium ${statusColors[order.status] || 'bg-gray-100'}`}>
                        {statusNames[order.status] || order.status}
                      </span>
                    </div>
                    <p className="text-xs text-gray-500 mt-1">{order.user_email}</p>
                    <div className="flex items-center justify-between mt-2">
                      <p className="text-sm font-bold text-gray-900">{formatPrice(order.total_amount)}</p>
                      <p className="text-xs text-gray-400">{new Date(order.created_at).toLocaleString('ko-KR')}</p>
                    </div>
                    <div className="mt-3 flex items-center gap-2">
                      <span className="text-xs text-gray-500">상태 변경:</span>
                      <select
                        value={order.status}
                        onChange={(e) => handleStatusChange(order.id, e.target.value)}
                        className="flex-1 px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-primary focus:outline-none"
                      >
                        <option value="READY">준비중</option>
                        <option value="DONE">결제완료</option>
                        <option value="SHIPPING">배송중</option>
                        <option value="DELIVERED">배송완료</option>
                        <option value="CANCELED">취소됨</option>
                      </select>
                    </div>
                  </div>
                ))}
              </div>

              {/* 주문 테이블 (sm 이상에서만 표시) — 3열 구조 */}
              <div className="hidden sm:block bg-white rounded-xl shadow-sm overflow-hidden">
                <div className="overflow-x-auto">
                  <table className="w-full text-sm">
                    <thead className="bg-gray-50">
                      <tr>
                        <th className="px-5 py-3 text-left font-medium text-gray-500">주문 정보</th>
                        <th className="px-5 py-3 text-right font-medium text-gray-500">금액 / 일시</th>
                        <th className="px-5 py-3 text-center font-medium text-gray-500">상태</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y">
                      {orders.map((order) => (
                        <tr key={order.id}>
                          <td className="px-5 py-4">
                            <p className="font-medium text-gray-900">{order.order_name}</p>
                            <p className="text-xs text-gray-500 mt-0.5">{order.user_email}</p>
                            <p className="text-xs text-gray-400 mt-0.5">{order.order_id}</p>
                          </td>
                          <td className="px-5 py-4 text-right">
                            <p className="font-bold text-gray-900">{formatPrice(order.total_amount)}</p>
                            <p className="text-xs text-gray-400 mt-0.5">{new Date(order.created_at).toLocaleString('ko-KR')}</p>
                          </td>
                          <td className="px-5 py-4 text-center">
                            <span className={`inline-block px-2 py-1 rounded-full text-xs font-medium ${statusColors[order.status] || 'bg-gray-100'}`}>
                              {statusNames[order.status] || order.status}
                            </span>
                            <div className="mt-2">
                              <select
                                value={order.status}
                                onChange={(e) => handleStatusChange(order.id, e.target.value)}
                                className="px-2 py-1.5 border rounded-lg text-xs focus:ring-2 focus:ring-primary focus:outline-none"
                              >
                                <option value="READY">준비중</option>
                                <option value="DONE">결제완료</option>
                                <option value="SHIPPING">배송중</option>
                                <option value="DELIVERED">배송완료</option>
                                <option value="CANCELED">취소됨</option>
                              </select>
                            </div>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>

              {/* 페이지네이션 */}
              {pagination.totalPages > 1 && (
                <div className="flex items-center justify-center gap-2 p-4 mt-3">
                  <button
                    onClick={() => loadOrders(pagination.page - 1)}
                    disabled={pagination.page <= 1}
                    className="px-4 py-2 sm:px-3 sm:py-1 border rounded-lg sm:rounded text-sm disabled:opacity-30 hover:bg-gray-50"
                  >
                    이전
                  </button>
                  <span className="text-sm text-gray-600">
                    {pagination.page} / {pagination.totalPages}
                  </span>
                  <button
                    onClick={() => loadOrders(pagination.page + 1)}
                    disabled={pagination.page >= pagination.totalPages}
                    className="px-4 py-2 sm:px-3 sm:py-1 border rounded-lg sm:rounded text-sm disabled:opacity-30 hover:bg-gray-50"
                  >
                    다음
                  </button>
                </div>
              )}
            </>
          )}
        </div>
      );
    }

    // --- 마이페이지 (일반 회원 주문 내역) ---
    function MyPage({ onBack, user }) {
      const [orders, setOrders] = React.useState([]);
      const [loading, setLoading] = React.useState(true);
      const [statusFilter, setStatusFilter] = React.useState('');
      const [expandedId, setExpandedId] = React.useState(null); // 펼쳐볼 주문 ID

      // 내 주문 목록 불러오기
      async function loadOrders() {
        setLoading(true);
        try {
          const token = localStorage.getItem('token');
          const res = await fetch('/api/orders', {
            headers: { 'Authorization': 'Bearer ' + token },
          });
          const data = await res.json();
          if (res.ok) setOrders(data.orders || []);
        } catch (err) {
          console.error('주문 내역 로딩 실패:', err);
        }
        setLoading(false);
      }

      React.useEffect(() => { loadOrders(); }, []);

      // 상태별 색상
      const statusColors = {
        READY: 'bg-yellow-100 text-yellow-700',
        DONE: 'bg-blue-100 text-blue-700',
        SHIPPING: 'bg-purple-100 text-purple-700',
        DELIVERED: 'bg-green-100 text-green-700',
        CANCELED: 'bg-red-100 text-red-700',
      };
      const statusNames = {
        READY: '준비중', DONE: '결제완료', SHIPPING: '배송중',
        DELIVERED: '배송완료', CANCELED: '취소됨',
      };

      // 상태 필터 적용
      const filteredOrders = statusFilter
        ? orders.filter(o => o.status === statusFilter)
        : orders;

      return (
        <div className="min-h-screen bg-gray-50">
          {/* 마이페이지 헤더 */}
          <header className="bg-white shadow-sm sticky top-0 z-40">
            <div className="max-w-3xl mx-auto px-4 py-4 flex items-center gap-4">
              <button onClick={onBack} className="text-gray-600 hover:text-gray-900 transition-colors">
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                </svg>
              </button>
              <h1 className="text-xl font-bold text-gray-900">마이페이지</h1>
            </div>
          </header>

          <main className="max-w-3xl mx-auto px-4 py-6 space-y-6">
            {/* 사용자 정보 카드 */}
            <div className="bg-white rounded-xl shadow-sm p-6">
              <div className="flex items-center gap-3">
                <div className="w-12 h-12 bg-primary bg-opacity-10 rounded-full flex items-center justify-center">
                  <svg className="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                  </svg>
                </div>
                <div>
                  <p className="font-bold text-gray-900">{user.email}</p>
                  <p className="text-sm text-gray-500">총 {orders.length}건의 주문</p>
                </div>
              </div>
            </div>

            {/* 주문 내역 */}
            <div>
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-lg font-bold text-gray-900">주문 내역</h2>
                <select
                  value={statusFilter}
                  onChange={(e) => setStatusFilter(e.target.value)}
                  className="text-sm border rounded-lg px-3 py-1.5 focus:ring-2 focus:ring-primary focus:outline-none"
                >
                  <option value="">전체 상태</option>
                  <option value="READY">준비중</option>
                  <option value="DONE">결제완료</option>
                  <option value="SHIPPING">배송중</option>
                  <option value="DELIVERED">배송완료</option>
                  <option value="CANCELED">취소됨</option>
                </select>
              </div>

              {loading ? (
                <div className="text-center py-12">
                  <div className="inline-block w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
                </div>
              ) : filteredOrders.length === 0 ? (
                <div className="text-center py-12 bg-white rounded-xl shadow-sm">
                  <svg className="w-16 h-16 mx-auto text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                  </svg>
                  <p className="mt-4 text-gray-500">주문 내역이 없습니다</p>
                </div>
              ) : (
                <div className="space-y-3">
                  {filteredOrders.map((order) => (
                    <div key={order.id} className="bg-white rounded-xl shadow-sm overflow-hidden">
                      {/* 주문 요약 (클릭하면 펼침) */}
                      <button
                        onClick={() => setExpandedId(expandedId === order.id ? null : order.id)}
                        className="w-full p-4 text-left hover:bg-gray-50 transition-colors"
                      >
                        <div className="flex items-center justify-between">
                          <div className="flex-1 min-w-0">
                            <p className="font-medium text-gray-900 truncate">{order.order_name}</p>
                            <p className="text-sm text-gray-500 mt-1">
                              {new Date(order.created_at).toLocaleDateString('ko-KR')} · {order.method || '결제대기'}
                            </p>
                          </div>
                          <div className="flex items-center gap-3 ml-4 flex-shrink-0">
                            <span className="font-bold text-gray-900">{formatPrice(order.total_amount)}</span>
                            <span className={`px-2 py-1 rounded-full text-xs font-medium ${statusColors[order.status] || 'bg-gray-100 text-gray-600'}`}>
                              {statusNames[order.status] || order.status}
                            </span>
                            <svg className={`w-4 h-4 text-gray-400 transition-transform ${expandedId === order.id ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                            </svg>
                          </div>
                        </div>
                      </button>

                      {/* 펼침: 주문 상품 상세 */}
                      {expandedId === order.id && (
                        <div className="border-t px-4 py-3 bg-gray-50">
                          <p className="text-xs text-gray-500 mb-2">주문번호: {order.order_id}</p>
                          {(order.items || []).map((item, idx) => (
                            <div key={idx} className="flex items-center gap-3 py-2">
                              {item.image && (
                                <img src={item.image} alt="" className="w-10 h-14 object-cover rounded" />
                              )}
                              <div className="flex-1 min-w-0">
                                <p className="text-sm font-medium text-gray-900 truncate">{item.title}</p>
                                <p className="text-xs text-gray-500">{formatPrice(item.price)} x {item.quantity}권</p>
                              </div>
                              <p className="text-sm font-medium text-gray-900">{formatPrice(item.price * item.quantity)}</p>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              )}
            </div>
          </main>
        </div>
      );
    }

    // --- 관리자 메인 페이지 (탭 네비게이션) ---
    function AdminPage({ onBack, showToast }) {
      const [activeTab, setActiveTab] = React.useState('books'); // 'books' 또는 'orders'

      return (
        <div className="min-h-screen bg-gray-50">
          {/* 관리자 헤더 */}
          <header className="bg-white shadow-sm sticky top-0 z-40">
            <div className="max-w-7xl mx-auto px-4 py-4 flex items-center gap-4">
              <button onClick={onBack} className="text-gray-600 hover:text-gray-900 transition-colors">
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                </svg>
              </button>
              <h1 className="text-xl font-bold text-gray-900">관리자 페이지</h1>
            </div>
            {/* 탭 */}
            <div className="max-w-7xl mx-auto px-4">
              <div className="flex border-b">
                <button
                  onClick={() => setActiveTab('books')}
                  className={`px-4 sm:px-6 py-3 text-sm font-medium border-b-2 transition-colors ${
                    activeTab === 'books'
                      ? 'border-primary text-primary'
                      : 'border-transparent text-gray-500 hover:text-gray-700'
                  }`}
                >
                  상품 관리
                </button>
                <button
                  onClick={() => setActiveTab('orders')}
                  className={`px-4 sm:px-6 py-3 text-sm font-medium border-b-2 transition-colors ${
                    activeTab === 'orders'
                      ? 'border-primary text-primary'
                      : 'border-transparent text-gray-500 hover:text-gray-700'
                  }`}
                >
                  주문 관리
                </button>
              </div>
            </div>
          </header>

          {/* 탭 내용 */}
          <main className="max-w-7xl mx-auto px-4 py-4 sm:py-6">
            {activeTab === 'books' ? (
              <AdminBooks showToast={showToast} />
            ) : (
              <AdminOrders showToast={showToast} />
            )}
          </main>
        </div>
      );
    }

    // ============================================
    // 🏠 9단계: 메인 App 컴포넌트
    // ============================================
    // 모든 것을 하나로 합치는 최상위 컴포넌트
    function App() {
      // --- React 상태(state) 관리 ---
      // state = 컴포넌트가 기억하는 데이터. 값이 바뀌면 화면이 자동으로 다시 그려져요.

      // === 상품 데이터 (서버에서 로딩) ===
      const [books, setBooks] = React.useState([]);
      // books: 서버 API에서 불러온 책 목록
      const [booksLoading, setBooksLoading] = React.useState(true);
      // booksLoading: 책 데이터를 불러오는 중인지

      // cart: 장바구니에 담긴 책 목록 (배열)
      // localStorage에서 장바구니를 복원해요 (토스 결제 후 리다이렉트 시 데이터 유지 목적)
      // 결제 완료 → 토스가 /success로 리다이렉트 → 페이지 새로고침 → cart가 [] 초기화되는 문제 방지!
      const [cart, setCart] = React.useState(() => {
        try {
          const saved = localStorage.getItem('cart');
          return saved ? JSON.parse(saved) : [];
        } catch { return []; }
      });

      // cart가 변경될 때마다 localStorage에 저장 (새로고침 후에도 복원 가능)
      React.useEffect(() => {
        localStorage.setItem('cart', JSON.stringify(cart));
      }, [cart]);

      const [isCartOpen, setIsCartOpen] = React.useState(false);
      // isCartOpen: 장바구니 패널이 열려있는지 (true/false)

      const [selectedCategory, setSelectedCategory] = React.useState("전체");
      // selectedCategory: 현재 선택된 카테고리

      const [searchQuery, setSearchQuery] = React.useState("");
      // searchQuery: 검색창에 입력된 텍스트

      const defaultCount = window.innerWidth >= 640 ? 8 : 5;
      // 모바일(640px 미만): 5개, PC/태블릿(640px 이상): 8개
      const [visibleCount, setVisibleCount] = React.useState(defaultCount);

      const [selectedBook, setSelectedBook] = React.useState(null);
      // selectedBook: 상세보기로 선택된 책 (없으면 null)

      const [toast, setToast] = React.useState(null);
      // toast: 알림 메시지 (예: "장바구니에 담았습니다")

      // === 인증(로그인) 관련 상태 ===
      const [user, setUser] = React.useState(null);
      // user: 로그인된 사용자 정보 (null이면 비로그인 상태)
      // user.role: 'user' 또는 'admin' (관리자 여부)

      const [showLogin, setShowLogin] = React.useState(false);
      // showLogin: 로그인 모달을 보여줄지 여부

      const [showRegister, setShowRegister] = React.useState(false);
      // showRegister: 회원가입 모달을 보여줄지 여부

      // === 결제 관련 상태 ===
      const [currentPage, setCurrentPage] = React.useState('home');
      // currentPage: 현재 표시 중인 페이지
      // 'home' = 메인 페이지, 'checkout' = 결제 페이지, 'success' = 성공, 'fail' = 실패
      // 'admin' = 관리자 페이지 (관리자만 접근 가능)

      const [paymentResult, setPaymentResult] = React.useState(null);
      // paymentResult: 결제 승인 결과 데이터 (성공/실패 페이지에서 사용)

      // === 페이지 로드 시 자동 로그인 확인 ===
      // useEffect: 컴포넌트가 처음 화면에 나타날 때 한 번 실행되는 함수
      // (빈 배열 []을 넣으면 "처음 한 번만" 실행)
      React.useEffect(() => {
        const token = localStorage.getItem('token');
        if (token) {
          // 토큰이 있으면 → 서버에 "이 토큰 아직 유효해?" 확인
          fetch('/api/me', {
            headers: { 'Authorization': 'Bearer ' + token }
          })
          .then(res => res.json())
          .then(data => {
            if (data.user) {
              setUser(data.user); // 유효하면 → 로그인 상태로 설정
            } else {
              localStorage.removeItem('token'); // 무효하면 → 토큰 삭제
            }
          })
          .catch(() => localStorage.removeItem('token'));
        }
      }, []);

      // === 서버에서 상품 데이터 로딩 ===
      // 컴포넌트가 처음 나타날 때 /api/books API를 호출해서 책 목록을 가져와요
      React.useEffect(() => {
        fetch('/api/books')
          .then(res => res.json())
          .then(data => {
            if (data.books) {
              setBooks(data.books);
            }
          })
          .catch(err => console.error('상품 로딩 실패:', err))
          .finally(() => setBooksLoading(false));
      }, []);

      // 카테고리 목록을 books 데이터에서 동적으로 생성
      // books가 바뀔 때마다 자동으로 다시 계산돼요 (useMemo)
      const categories = React.useMemo(() => {
        const cats = [...new Set(books.map(b => b.category))]; // 중복 제거
        return ['전체', ...cats];
      }, [books]);

      // === 결제 결과 URL 감지 ===
      // 토스페이먼츠 결제가 완료되면 /success 또는 /fail로 리다이렉트돼요
      // 이 useEffect가 URL을 감지해서 적절한 페이지를 보여줍니다
      React.useEffect(() => {
        const pathname = window.location.pathname;
        const urlParams = new URLSearchParams(window.location.search);

        if (pathname === '/success') {
          // 결제 성공 리다이렉트 감지!
          setCurrentPage('success');
          // URL에서 결제 정보 추출
          const paymentKey = urlParams.get('paymentKey');
          const orderId = urlParams.get('orderId');
          const amount = urlParams.get('amount');

          if (paymentKey && orderId && amount) {
            // 서버에 결제 승인 요청 보내기
            confirmPayment(paymentKey, orderId, parseInt(amount));
          }
        } else if (pathname === '/fail') {
          // 결제 실패 리다이렉트 감지
          setCurrentPage('fail');
          setPaymentResult({
            success: false,
            code: urlParams.get('code'),
            message: urlParams.get('message'),
          });
        }
      }, []);

      // === 결제 승인 요청 함수 ===
      // 토스페이먼츠 리다이렉트 후 서버에 결제를 "확정"하는 요청을 보내요
      // 이 단계가 있어야 실제로 결제가 완료됩니다!
      async function confirmPayment(paymentKey, orderId, amount) {
        try {
          const token = localStorage.getItem('token');
          const response = await fetch('/api/payments/confirm', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token,
            },
            body: JSON.stringify({
              paymentKey,
              orderId,
              amount,
              // 장바구니 상품 정보도 함께 전달 (DB에 저장용)
              items: cart.map(item => ({
                bookId: item.id,
                title: item.title,
                author: item.author,
                price: item.price,
                quantity: item.quantity,
              })),
            }),
          });

          const data = await response.json();

          if (response.ok) {
            // 결제 승인 성공!
            setPaymentResult({ success: true, data });
            setCart([]); // 장바구니 비우기
          } else {
            // 결제 승인 실패
            setPaymentResult({
              success: false,
              code: data.code || 'CONFIRM_ERROR',
              message: data.message || '결제 승인에 실패했습니다',
            });
          }
        } catch (error) {
          setPaymentResult({
            success: false,
            code: 'NETWORK_ERROR',
            message: '서버 연결에 실패했습니다',
          });
        }
      }

      // === 주문하기 버튼 핸들러 ===
      // 장바구니의 "주문하기" 버튼을 누르면 실행돼요
      function handleCheckout() {
        // 로그인 확인: 결제하려면 반드시 로그인해야 해요
        if (!user) {
          setIsCartOpen(false);
          setShowLogin(true);
          showToast('주문하려면 로그인이 필요합니다');
          return;
        }
        // 장바구니가 비어있으면 아무것도 안 함
        if (cart.length === 0) return;
        // 장바구니 패널 닫고 결제 페이지로 이동
        setIsCartOpen(false);
        setCurrentPage('checkout');
      }

      // === 로그아웃 함수 ===
      function handleLogout() {
        localStorage.removeItem('token'); // 저장된 토큰 삭제
        setUser(null);                     // 사용자 정보 초기화
        setCurrentPage('home');            // 관리자 페이지에서 나가기
        showToast('로그아웃 되었습니다');
      }

      // --- 책 필터링 로직 ---
      // 카테고리와 검색어에 맞는 책만 골라내기
      const filteredBooks = books.filter((book) => {
        // 1. 카테고리 필터: "전체"이면 통과, 아니면 같은 카테고리만
        const matchesCategory =
          selectedCategory === "전체" || book.category === selectedCategory;

        // 2. 검색 필터: 제목이나 저자에 검색어가 포함되어 있는지 확인
        const matchesSearch =
          book.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
          book.author.toLowerCase().includes(searchQuery.toLowerCase());

        // 둘 다 만족해야 표시
        return matchesCategory && matchesSearch;
      });

      // --- 장바구니 담기 함수 ---
      function addToCart(book) {
        setCart((prevCart) => {
          // 이미 장바구니에 같은 책이 있는지 확인
          const existingItem = prevCart.find((item) => item.id === book.id);

          if (existingItem) {
            // 이미 있으면 → 수량만 1 증가
            return prevCart.map((item) =>
              item.id === book.id
                ? { ...item, quantity: item.quantity + 1 }
                : item
            );
          } else {
            // 없으면 → 새로 추가 (수량 1로 시작)
            return [...prevCart, { ...book, quantity: 1 }];
          }
        });

        // 토스트 알림 표시
        showToast(`"${book.title}" 을(를) 장바구니에 담았습니다!`);
      }

      // --- 수량 변경 함수 ---
      function updateQuantity(bookId, newQuantity) {
        if (newQuantity <= 0) {
          // 수량이 0 이하면 → 장바구니에서 제거
          removeFromCart(bookId);
          return;
        }
        setCart((prevCart) =>
          prevCart.map((item) =>
            item.id === bookId ? { ...item, quantity: newQuantity } : item
          )
        );
      }

      // --- 장바구니에서 제거 함수 ---
      function removeFromCart(bookId) {
        setCart((prevCart) => prevCart.filter((item) => item.id !== bookId));
      }

      // --- 토스트 알림 표시 함수 ---
      function showToast(message) {
        setToast(message);
        // 2초 후 자동으로 사라짐
        setTimeout(() => setToast(null), 2000);
      }

      // 장바구니 총 수량 (헤더 뱃지에 표시)
      const cartItemCount = cart.reduce((sum, item) => sum + item.quantity, 0);

      // --- 화면 렌더링 ---
      // currentPage에 따라 다른 페이지를 보여줘요
      // 'checkout' → 결제 페이지, 'success' → 성공 페이지, 'fail' → 실패 페이지
      // 'admin' → 관리자 페이지 (상품 관리 + 주문 관리)
      // 마이페이지: 로그인한 회원의 주문 내역 확인
      if (currentPage === 'mypage' && user) {
        return (
          <MyPage
            onBack={() => setCurrentPage('home')}
            user={user}
          />
        );
      }

      if (currentPage === 'admin' && user?.role === 'admin') {
        return (
          <AdminPage
            onBack={() => {
              setCurrentPage('home');
              // 관리자가 상품을 변경했을 수 있으니 목록 새로고침
              fetch('/api/books')
                .then(res => res.json())
                .then(data => { if (data.books) setBooks(data.books); })
                .catch(() => {});
            }}
            showToast={showToast}
          />
        );
      }

      if (currentPage === 'checkout') {
        return (
          <CheckoutPage
            cart={cart}
            user={user}
            onBack={() => setCurrentPage('home')}
            showToast={showToast}
          />
        );
      }

      if (currentPage === 'success') {
        return (
          <SuccessPage
            result={paymentResult}
            onGoHome={() => {
              setCurrentPage('home');
              setPaymentResult(null);
            }}
          />
        );
      }

      if (currentPage === 'fail') {
        return (
          <FailPage
            result={paymentResult}
            onGoHome={() => {
              setCurrentPage('home');
              setPaymentResult(null);
            }}
          />
        );
      }

      // currentPage === 'home' → 기존 메인 페이지
      return (
        <div className="min-h-screen bg-gray-50">
          {/* min-h-screen: 최소 높이를 화면 전체로 (내용이 적어도 배경이 꽉 참) */}
          {/* bg-gray-50: 아주 연한 회색 배경 */}

          {/* ========== 헤더 (상단 네비게이션 바) ========== */}
          <header className="bg-white shadow-sm sticky top-0 z-40">
            {/* sticky top-0: 스크롤해도 화면 상단에 붙어있음 */}
            {/* z-40: 다른 콘텐츠보다 위에 표시 */}
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
              {/* max-w-7xl: 최대 너비 제한 (너무 넓은 화면에서 가운데 정렬) */}
              {/* mx-auto: 좌우 마진 자동 → 가운데 정렬 */}
              <div className="flex items-center justify-between h-16">

                {/* 로고 — 클릭하면 홈으로 이동 + 새로고침 */}
                <button
                  onClick={() => window.location.reload()}
                  className="flex items-center gap-2 cursor-pointer"
                >
                  <svg className="w-8 h-8 text-primary" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                  </svg>
                  <h1 className="text-xl font-bold text-gray-900">
                    북<span className="text-primary">샵</span>
                  </h1>
                </button>

                {/* 검색바 */}
                <div className="flex-1 max-w-lg mx-8 hidden sm:block">
                  {/* hidden sm:block: 작은 화면에서는 숨기고, sm(640px) 이상에서 표시 */}
                  <div className="relative">
                    {/* 돋보기 아이콘 */}
                    <svg className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    {/* 검색 입력창 */}
                    <input
                      type="text"
                      placeholder="책 제목, 저자로 검색..."
                      value={searchQuery}
                      onChange={(e) => { setSearchQuery(e.target.value); setVisibleCount(defaultCount); }}
                      className="w-full pl-10 pr-4 py-2 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50"
                      /* pl-10: 왼쪽 안쪽 여백 40px (돋보기 아이콘 공간 확보) */
                      /* rounded-full: 완전한 둥근 모서리 (알약 모양) */
                      /* focus:ring-2: 클릭(포커스)하면 파란색 테두리 강조 */
                    />
                  </div>
                </div>

                {/* ===== 로그인/사용자 정보 + 장바구니 영역 ===== */}
                <div className="flex items-center gap-1.5 sm:gap-3">
                  {user ? (
                    /* 로그인 되었을 때: 사용자 이름 + 로그아웃 버튼 */
                    <div className="flex items-center gap-1.5 sm:gap-2">
                      {/* 사용자 아이콘 */}
                      <svg className="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                      </svg>
                      <span className="text-xs sm:text-sm font-medium text-gray-700 max-w-[120px] sm:max-w-none truncate">
                        {user.email}님
                      </span>
                      {/* 마이페이지 버튼: 로그인한 모든 사용자에게 표시 */}
                      <button
                        onClick={() => setCurrentPage('mypage')}
                        className="text-xs sm:text-sm text-gray-600 hover:text-primary font-medium transition-colors"
                      >
                        마이페이지
                      </button>
                      {/* 관리자 버튼: role이 'admin'인 경우에만 표시 */}
                      {user.role === 'admin' && (
                        <button
                          onClick={() => setCurrentPage('admin')}
                          className="text-xs sm:text-sm bg-gray-800 text-white px-2 sm:px-3 py-1 sm:py-1.5 rounded-lg hover:bg-gray-900 transition-colors"
                        >
                          관리자
                        </button>
                      )}
                      <button
                        onClick={handleLogout}
                        className="text-xs sm:text-sm text-gray-500 hover:text-gray-700 transition-colors"
                      >
                        로그아웃
                      </button>
                    </div>
                  ) : (
                    /* 로그인 안 되었을 때: 로그인/회원가입 버튼 */
                    <div className="flex items-center gap-2">
                      <button
                        onClick={() => setShowLogin(true)}
                        className="text-sm font-medium text-gray-600 hover:text-primary transition-colors"
                      >
                        로그인
                      </button>
                      <button
                        onClick={() => setShowRegister(true)}
                        className="text-sm bg-primary text-white px-3 py-1.5 rounded-lg hover:bg-blue-700 transition-colors"
                      >
                        회원가입
                      </button>
                    </div>
                  )}

                  {/* 장바구니 버튼 */}
                  <button
                    onClick={() => setIsCartOpen(true)}
                    className="relative p-2 text-gray-600 hover:text-primary transition-colors"
                  >
                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 100 4 2 2 0 000-4z" />
                    </svg>
                    {cartItemCount > 0 && (
                      <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold w-5 h-5 rounded-full flex items-center justify-center">
                        {cartItemCount}
                      </span>
                    )}
                  </button>
                </div>
              </div>

              {/* 모바일용 검색바 (작은 화면에서만 표시) */}
              <div className="sm:hidden pb-3">
                <div className="relative">
                  <svg className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                  </svg>
                  <input
                    type="text"
                    placeholder="책 제목, 저자로 검색..."
                    value={searchQuery}
                    onChange={(e) => { setSearchQuery(e.target.value); setVisibleCount(defaultCount); }}
                    className="w-full pl-10 pr-4 py-2 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50"
                  />
                </div>
              </div>
            </div>
          </header>

          {/* ========== 히어로 배너 (검색 중이 아닐 때만 표시) ========== */}
          {!searchQuery.trim() && (
            <HeroSection books={books} onSelectBook={setSelectedBook} />
          )}

          {/* ========== 메인 콘텐츠 영역 ========== */}
          <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

            {/* 카테고리 필터 버튼들 */}
            <div className="flex flex-wrap gap-2 mb-8">
              {/* flex-wrap: 버튼이 많으면 자동으로 다음 줄로 */}
              {/* gap-2: 버튼 사이 간격 8px */}
              {categories.map((category) => (
                <button
                  key={category}
                  onClick={() => { setSelectedCategory(category); setVisibleCount(defaultCount); }}
                  className={`px-4 py-2 rounded-full text-sm font-medium transition-colors duration-200 ${
                    /* 선택된 카테고리는 파란색 배경, 나머지는 회색 배경 */
                    selectedCategory === category
                      ? "bg-primary text-white"
                      : "bg-white text-gray-600 hover:bg-gray-100 border border-gray-300"
                  }`}
                >
                  {category}
                </button>
              ))}
            </div>

            {/* 검색 결과 개수 */}
            <p className="text-sm text-gray-500 mb-4">
              {filteredBooks.length}권의 책이 있습니다
              {filteredBooks.length > visibleCount && (
                <span className="text-gray-400"> (현재 {Math.min(visibleCount, filteredBooks.length)}개 표시)</span>
              )}
            </p>

            {/* 책 카드 그리드 (격자 배열) */}
            {booksLoading ? (
              <div className="text-center py-16">
                <div className="inline-block w-10 h-10 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
                <p className="text-gray-500 mt-4">상품을 불러오는 중...</p>
              </div>
            ) : filteredBooks.length > 0 ? (
              <>
                <div className="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-6">
                  {filteredBooks.slice(0, visibleCount).map((book) => (
                    <div key={book.id} onClick={() => setSelectedBook(book)} className="cursor-pointer h-full">
                      <BookCard book={book} onAddToCart={addToCart} />
                    </div>
                  ))}
                </div>
                {/* 더보기 버튼: 아직 안 보이는 상품이 있을 때만 표시 */}
                {visibleCount < filteredBooks.length && (
                  <div className="text-center mt-8">
                    <button
                      onClick={() => setVisibleCount(prev => prev + 5)}
                      className="bg-white border-2 border-primary text-primary hover:bg-primary hover:text-white px-8 py-3 rounded-full font-medium transition-colors"
                    >
                      더보기 ({filteredBooks.length - visibleCount}개 남음)
                    </button>
                  </div>
                )}
              </>
            ) : (
              /* 검색 결과가 없을 때 */
              <div className="text-center py-16">
                <svg className="w-16 h-16 mx-auto text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <p className="mt-4 text-gray-500 text-lg">검색 결과가 없습니다</p>
                <p className="text-gray-400 text-sm mt-1">다른 검색어를 입력해보세요</p>
              </div>
            )}
          </main>

          {/* ========== 푸터 ========== */}
          <footer className="bg-gray-900 text-gray-400 mt-16">
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
              <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                {/* 회사 정보 */}
                <div>
                  <h3 className="text-white font-bold text-lg mb-4">
                    북<span className="text-primary">샵</span>
                  </h3>
                  <p className="text-sm leading-relaxed">
                    좋은 책과 독자를 연결하는 온라인 서점입니다.
                    다양한 분야의 책을 합리적인 가격에 만나보세요.
                  </p>
                </div>
                {/* 고객 서비스 */}
                <div>
                  <h3 className="text-white font-bold mb-4">고객 서비스</h3>
                  <ul className="space-y-2 text-sm">
                    <li><a href="#" className="hover:text-white transition-colors">자주 묻는 질문</a></li>
                    <li><a href="#" className="hover:text-white transition-colors">배송 안내</a></li>
                    <li><a href="#" className="hover:text-white transition-colors">반품/교환</a></li>
                    <li><a href="#" className="hover:text-white transition-colors">1:1 문의</a></li>
                  </ul>
                </div>
                {/* 연락처 */}
                <div>
                  <h3 className="text-white font-bold mb-4">연락처</h3>
                  <ul className="space-y-2 text-sm">
                    <li>전화: 1234-5678</li>
                    <li>이메일: help@bookshop.kr</li>
                    <li>운영시간: 평일 09:00 - 18:00</li>
                  </ul>
                </div>
              </div>
              {/* 저작권 표시 */}
              <div className="border-t border-gray-800 mt-8 pt-8 text-center text-sm">
                © 2026 북샵. All rights reserved.
              </div>
            </div>
          </footer>

          {/* ========== 장바구니 패널 (열려있을 때만 표시) ========== */}
          {isCartOpen && (
            <CartPanel
              cart={cart}
              onClose={() => setIsCartOpen(false)}
              onUpdateQuantity={updateQuantity}
              onRemove={removeFromCart}
              onCheckout={handleCheckout}
            />
          )}

          {/* ========== 책 상세 모달 (책을 클릭했을 때만 표시) ========== */}
          {selectedBook && (
            <BookDetail
              book={selectedBook}
              onClose={() => setSelectedBook(null)}
              onAddToCart={addToCart}
            />
          )}

          {/* ========== 로그인 모달 ========== */}
          {showLogin && (
            <LoginModal
              onClose={() => setShowLogin(false)}
              onSwitchToRegister={() => {
                setShowLogin(false);    // 로그인 모달 닫고
                setShowRegister(true);  // 회원가입 모달 열기
              }}
              onLoginSuccess={(userData) => {
                setUser(userData);                          // 사용자 정보 저장
                showToast(userData.email + '님 환영합니다!'); // 환영 메시지
              }}
            />
          )}

          {/* ========== 회원가입 모달 ========== */}
          {showRegister && (
            <RegisterModal
              onClose={() => setShowRegister(false)}
              onSwitchToLogin={() => {
                setShowRegister(false); // 회원가입 모달 닫고
                setShowLogin(true);     // 로그인 모달 열기
                showToast('회원가입이 완료되었습니다! 로그인해주세요.');
              }}
            />
          )}

          {/* ========== 토스트 알림 (장바구니 담기 시 표시) ========== */}
          {toast && (
            <div className="fixed bottom-6 left-1/2 -translate-x-1/2 z-50 bg-gray-800 text-white px-6 py-3 rounded-full shadow-lg text-sm font-medium animate-bounce">
              {/* fixed bottom-6: 화면 하단에 고정 */}
              {/* left-1/2 -translate-x-1/2: 정확한 가운데 정렬 */}
              {toast}
            </div>
          )}
        </div>
      );
    }

    // ============================================
    // 🚀 8단계: React 앱 시작!
    // ============================================
    // React 18의 새로운 방식으로 앱을 화면에 렌더링(그리기)합니다
    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
