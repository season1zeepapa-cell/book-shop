# ==============================================
# GitHub Actions 자동 배포 워크플로우
#
# 동작 흐름:
# 1. main 브랜치에 push 발생
# 2. GitHub Actions가 자동으로 이 워크플로우 실행
# 3. SSH로 Lightsail 인스턴스에 접속
# 4. 배포 스크립트(scripts/deploy.sh) 실행
#
# 필요한 GitHub Secrets (저장소 Settings → Secrets에서 설정):
#   LIGHTSAIL_HOST     — Lightsail 인스턴스 공인 IP 주소
#   LIGHTSAIL_USERNAME — SSH 사용자명 (보통 ubuntu)
#   LIGHTSAIL_SSH_KEY  — SSH 프라이빗 키 (전체 내용)
# ==============================================

name: Deploy to AWS Lightsail

# main 브랜치에 push 될 때만 실행
on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy book-shop
    runs-on: ubuntu-latest

    steps:
      # 1단계: 코드 체크아웃
      - name: Checkout code
        uses: actions/checkout@v4

      # 2단계: SSH로 Lightsail에 접속하여 배포 스크립트 실행
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.LIGHTSAIL_HOST }}
          username: ${{ secrets.LIGHTSAIL_USERNAME }}
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          script: |
            bash /home/ubuntu/book-shop/scripts/deploy.sh

      # 3단계: HTTPS 헬스체크 (배포 후 사이트 접속 확인)
      - name: Health check
        run: |
          sleep 5
          curl -sf --max-time 10 https://bookshop.aifac.click/api/books > /dev/null && echo "Health check passed" || echo "Warning: Health check failed"
